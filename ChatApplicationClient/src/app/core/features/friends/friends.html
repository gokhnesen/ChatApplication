<div class="friends-container">

  <div class="me-header">
    <img class="me-avatar"
         [src]="currentUser?.profilePhotoUrl | profilePhoto">
    <div class="me-meta">
      <div class="me-info">
        <div class="me-name">{{ currentUser?.name }} {{ currentUser?.lastName }}</div>
      </div>
      <div class="friend-requests-wrapper" *ngIf="pendingRequestCount > 0">
        <button class="friend-requests-btn" (click)="openFriendRequests()" title="Arkadaşlık İstekleri">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
          <span class="request-count">{{ pendingRequestCount }}</span>
        </button>
      </div>
    </div>
  </div>

  <div class="search-bar">
    <i class="fas fa-search search-icon"></i>
    <input 
      type="text" 
      [(ngModel)]="searchText" 
      placeholder="Arkadaş ara..." 
      (input)="filterFriends()"
      class="search-input">
  </div>

  <div class="friends-list">
    <div 
      *ngFor="let friend of filteredFriends" 
      class="friend-item"
      [class.active]="selectedFriend?.id === friend.id"
      [class.has-unread]="friend.unreadMessageCount && friend.unreadMessageCount > 0"
      (click)="selectFriend(friend)">
      
      <img [src]="friend.profilePhotoUrl | profilePhoto" alt="avatar" class="friend-avatar">
      
      <div class="friend-info">
        <div class="friend-header">
          <h4 class="friend-name">{{ friend.name }} {{ friend.lastName }}</h4>
          <span class="last-message-time">{{ getLastMessageTime(friend) }}</span>
        </div>
        
        <div class="friend-footer">
          <!-- ✅ TİP BAZLI ÖNİZLEME -->
          <p class="last-message" [class.unread]="isLastMessageUnread(friend)">
            {{ getLastMessagePreview(friend) }}
          </p>
          
          <span class="unread-badge" *ngIf="friend.unreadMessageCount && friend.unreadMessageCount > 0">
            {{ friend.unreadMessageCount }}
          </span>
        </div>
      </div>
    </div>

    <div *ngIf="filteredFriends.length === 0" class="no-friends">
      <p>{{ searchText ? 'Arkadaş bulunamadı' : 'Henüz arkadaşınız yok' }}</p>
    </div>
  </div>

  <!-- Friend Requests Modal -->
  <app-friend-request
    *ngIf="showFriendRequests"
    [pendingRequests]="pendingRequests"
    [requestsLoading]="requestsLoading"
    [requestsError]="requestsError"
    [processingRequests]="processingRequests"
    (respondToRequest)="onFriendRequestRespond($event)"
    (close)="onFriendRequestClose()"
    (retry)="onFriendRequestRetry()"
  ></app-friend-request>
</div>
